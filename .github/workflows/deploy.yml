name: Deploy NFT Portal

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-web:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-web:latest
          platforms: linux/amd64

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: frontend/Dockerfile
          target: prod
          push: true
          build-args: |
            VITE_API_BASE_URL=https://api.nftmarketplace.com.br
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
          platforms: linux/amd64

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          TAG: ${{ github.sha }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          FLOWER_BASIC_AUTH: ${{ secrets.FLOWER_BASIC_AUTH }}
          LE_EMAIL: ${{ secrets.LE_EMAIL }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$EC2_KEY" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          
          # Deploy script
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" bash -c "$(cat << 'DEPLOYSCRIPT'
          set -e
          
          echo "=== Iniciando deploy da versão ${{ github.sha }} ==="
          
          # Export environment variables
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_NAME="${{ env.IMAGE_NAME }}"
          export TAG="${{ github.sha }}"
          
          echo "Variáveis de ambiente exportadas:"
          echo "REGISTRY=\$REGISTRY"
          echo "IMAGE_NAME=\$IMAGE_NAME"  
          echo "TAG=\$TAG"
          
          # Login to GitHub Container Registry
          echo "Autenticando com GitHub Container Registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login --username ${{ github.actor }} --password-stdin ${{ env.REGISTRY }}
          
          # Navigate to project directory
          cd /opt/nft_portal
          
          # Stop and remove existing containers (use docker-compose for broader compatibility)
          echo "Parando containers existentes..."
          sudo docker-compose -f docker/docker-compose.prod.yml down || true
          
          # Force remove any leftover containers with conflicting names
          echo "Removendo containers órfãos..."
          sudo docker rm -f docker-certbot-1 docker-nginx-1 docker-frontend-1 docker-web-1 docker-celery_worker-1 docker-celery_beat-1 docker-flower-1 2>/dev/null || true
          
          # Pull latest images
          echo "Fazendo pull das novas imagens..."
          echo "Imagem web: ${REGISTRY}/${IMAGE_NAME}-web:${TAG}"
          echo "Imagem frontend: ${REGISTRY}/${IMAGE_NAME}-frontend:${TAG}"
          
          # Remove old images to force fresh pull
          echo "Removendo tags latest antigas..."
          sudo docker rmi ${REGISTRY}/${IMAGE_NAME}-web:latest 2>/dev/null || true
          sudo docker rmi ${REGISTRY}/${IMAGE_NAME}-frontend:latest 2>/dev/null || true
          sudo docker rmi ${REGISTRY}/${IMAGE_NAME}-web:${TAG} 2>/dev/null || true
          sudo docker rmi ${REGISTRY}/${IMAGE_NAME}-frontend:${TAG} 2>/dev/null || true
          
          # Pull fresh images with specific tag
          echo "Fazendo pull das imagens..."
          sudo docker pull ${REGISTRY}/${IMAGE_NAME}-web:${TAG}
          sudo docker pull ${REGISTRY}/${IMAGE_NAME}-frontend:${TAG}
          
          # Tag as latest
          echo "Marcando imagens como latest..."
          sudo docker tag ${REGISTRY}/${IMAGE_NAME}-web:${TAG} ${REGISTRY}/${IMAGE_NAME}-web:latest
          sudo docker tag ${REGISTRY}/${IMAGE_NAME}-frontend:${TAG} ${REGISTRY}/${IMAGE_NAME}-frontend:latest
          
          # Verify images with timestamp
          echo "Verificando imagens baixadas (com timestamp)..."
          sudo docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" | grep ${IMAGE_NAME} | grep -E "(web|frontend)"
          
          # Update .env file
          echo "Atualizando arquivo .env..."
          sudo tee .env >/dev/null << ENVEOF
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=nftmarketplace.com.br,www.nftmarketplace.com.br,api.nftmarketplace.com.br
          USE_POSTGRES=1
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          CELERY_BROKER_URL=redis://redis:6379/0
          CELERY_RESULT_BACKEND=redis://redis:6379/0
          FRONTEND_ORIGINS=https://nftmarketplace.com.br,https://www.nftmarketplace.com.br
          API_ORIGIN=https://api.nftmarketplace.com.br
          FLOWER_BASIC_AUTH=${{ secrets.FLOWER_BASIC_AUTH }}
          LE_EMAIL=${{ secrets.LE_EMAIL }}
          ENVEOF
          
          # Check if certificates already exist (check multiple possible locations)
          CERT_EXISTS=false
          if [ -f "/var/lib/docker/volumes/docker_letsencrypt/_data/live/nftmarketplace.com.br/fullchain.pem" ]; then
            CERT_EXISTS=true
          elif sudo docker volume ls | grep -q letsencrypt; then
            # Certificates exist in volume
            CERT_EXISTS=true
          fi
          
          if [ "$CERT_EXISTS" = "true" ]; then
            echo "Certificados SSL já existem, usando configuração HTTPS..."
            # Use HTTPS config
            sudo cp docker/nginx/nginx.ssl.conf docker/nginx/nginx.conf
          else
            echo "Certificados SSL não encontrados, iniciando com HTTP para obter certificados..."
            # Start with HTTP config
            sudo cp docker/nginx/nginx.conf.orig docker/nginx/nginx.conf
          fi
          
          # Start services with environment variables
          echo "========================================="
          echo "Iniciando containers com configuração:"
          echo "REGISTRY=${REGISTRY}"
          echo "IMAGE_NAME=${IMAGE_NAME}"
          echo "TAG=${TAG}"
          echo "========================================="
          echo "Image web será: ${REGISTRY}/${IMAGE_NAME}-web:${TAG}"
          echo "Image frontend será: ${REGISTRY}/${IMAGE_NAME}-frontend:${TAG}"
          echo "========================================="
          
          # Verify TAG is not empty
          if [ -z "${TAG}" ]; then
            echo "ERRO: TAG está vazio! Abortando..."
            exit 1
          fi
          
          # Verify REGISTRY is ghcr.io
          if [ "${REGISTRY}" != "ghcr.io" ]; then
            echo "ERRO: REGISTRY deve ser ghcr.io, mas é ${REGISTRY}!"
            echo "Abortando deployment para evitar usar registry errado..."
            exit 1
          fi
          
          # Verify we're using ghcr.io images
          echo "Confirmando uso de ghcr.io..."
          echo "Web image final: ${REGISTRY}/${IMAGE_NAME}-web:${TAG}"
          echo "Frontend image final: ${REGISTRY}/${IMAGE_NAME}-frontend:${TAG}"
          
          sudo env REGISTRY="${REGISTRY}" IMAGE_NAME="${IMAGE_NAME}" TAG="${TAG}" \
            docker-compose -f docker/docker-compose.prod.yml up -d --force-recreate
          
          # Verify containers are using the correct images
          echo "Verificando imagens dos containers..."
          sudo docker ps --format "table {{.Names}}\t{{.Image}}"
          
          # Show which exact images are running
          echo "Detalhes das imagens em execução:"
          sudo docker ps --format "{{.Names}}\t{{.Image}}" | while read name image; do
            echo "  $name: $image"
            # Get actual digest of image
            sudo docker inspect $image --format='{{.RepoDigests}}' 2>/dev/null || echo "    (sem digest)"
          done
          
          # Wait for services to be ready
          echo "Aguardando serviços iniciarem..."
          sleep 40
          
          # Request SSL certificates if they don't exist
          if [ "$CERT_EXISTS" = "false" ]; then
            echo "Solicitando certificados SSL da Let's Encrypt..."
            
            # Wait a bit more for nginx to be ready
            sleep 10
            
            # Request certificates
            if sudo docker ps --format '{{.Names}}' | grep -q '^docker-certbot-1$' && \
               sudo docker exec docker-certbot-1 certbot certonly \
              --webroot \
              --webroot-path=/var/www/certbot \
              --email ${{ secrets.LE_EMAIL }} \
              --agree-tos \
              --no-eff-email \
              --non-interactive \
              -d nftmarketplace.com.br \
              -d www.nftmarketplace.com.br \
              -d api.nftmarketplace.com.br; then
              
              echo "Certificados SSL obtidos com sucesso!"
              
              # Switch to HTTPS configuration
              echo "Alternando para configuração HTTPS..."
              sudo cp docker/nginx/nginx.ssl.conf docker/nginx/nginx.conf
              
              # Restart services with HTTPS config
              echo "Reiniciando containers com configuração HTTPS..."
              sudo docker-compose -f docker/docker-compose.prod.yml down
              sudo docker-compose -f docker/docker-compose.prod.yml up -d
              sleep 15
            else
              echo "Aviso: Não foi possível obter certificados SSL nesta execução."
            fi
          fi
          
          # Verify deployment
          echo "=== Verificando deploy ==="
          sudo docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
          
          # Test endpoints
          echo "Testando endpoints..."
          sleep 5
          
          if [ "$CERT_EXISTS" = "true" ]; then
            echo "Testando HTTPS endpoints..."
            curl -I https://nftmarketplace.com.br 2>/dev/null | head -n 1 || echo "HTTPS não funcionando ainda"
            curl -I https://api.nftmarketplace.com.br 2>/dev/null | head -n 1 || echo "API HTTPS não funcionando ainda"
          fi
          
          echo "=== Deploy concluído ==="
          DEPLOYSCRIPT
          )"